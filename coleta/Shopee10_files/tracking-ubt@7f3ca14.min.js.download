self.window.trackingSDK.define(["exports","https://deo.shopeemobile.com/shopee/shopee-trackingsdk-live-sg/amd/@shopee/tracking-core@7f3ca14.min.js"],(function(t,e){"use strict";var n=function(t,e){return n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])},n(t,e)};function o(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function o(){this.constructor=t}n(t,e),t.prototype=null===e?Object.create(e):(o.prototype=e.prototype,new o)}var r=function(){return r=Object.assign||function(t){for(var e,n=1,o=arguments.length;n<o;n++)for(var r in e=arguments[n])Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t},r.apply(this,arguments)};function a(t,e,n,o){return new(n||(n=Promise))((function(r,a){function i(t){try{c(o.next(t))}catch(t){a(t)}}function s(t){try{c(o.throw(t))}catch(t){a(t)}}function c(t){var e;t.done?r(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(i,s)}c((o=o.apply(t,e||[])).next())}))}function i(t,e){var n,o,r,a,i={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return a={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function s(s){return function(c){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;a&&(a=0,s[0]&&(i=0)),i;)try{if(n=1,o&&(r=2&s[0]?o.return:s[0]?o.throw||((r=o.return)&&r.call(o),0):o.next)&&!(r=r.call(o,s[1])).done)return r;switch(o=0,r&&(s=[2&s[0],r.value]),s[0]){case 0:case 1:r=s;break;case 4:return i.label++,{value:s[1],done:!1};case 5:i.label++,o=s[1],s=[0];continue;case 7:s=i.ops.pop(),i.trys.pop();continue;default:if(!(r=i.trys,(r=r.length>0&&r[r.length-1])||6!==s[0]&&2!==s[0])){i=0;continue}if(3===s[0]&&(!r||s[1]>r[0]&&s[1]<r[3])){i.label=s[1];break}if(6===s[0]&&i.label<r[1]){i.label=r[1],r=s;break}if(r&&i.label<r[2]){i.label=r[2],i.ops.push(s);break}r[2]&&i.ops.pop(),i.trys.pop();continue}s=e.call(t,i)}catch(t){s=[6,t],o=0}finally{n=r=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,c])}}}var s=["360","alice","alltheweb","altavista","aol","ask","auone","avg","babylon","baidu","biglobe","bing","centrum","comcast","conduit","cnn","daum","duckduckgo","ecosia","ekolay","eniro","globo","go.mail.ru","google","goo.ne","haosou.com","incredimail","kvasir","live","lycos","mamma","msn","mynet","najdi","naver","netscape","onet","ozu","rakuten","rambler","search-results","search.smt.docomo","sesam","seznam","so.com","sogou","startsiden","szukacz","terra","tut.by","ukr","virgilio","voila","wp.pl","yahoo","yandex","yam"],c="cdn.ampproject.org";var u=[],h=function(){function t(t,e){var n=this;this.context=t,this.methodName=e,this.originalMethodReference=t[e],this.methodChain=[],this.boundMethodChain=[],this.wrappedMethod=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return n.boundMethodChain[n.boundMethodChain.length-1].apply(void 0,t)},t[e]=this.wrappedMethod}return t.add=function(t,e,n){l(t,e).add(n)},t.remove=function(t,e,n){var o=p(t,e);o&&o.remove(n)},t.prototype.add=function(t){this.methodChain.push(t),this.rebindMethodChain()},t.prototype.remove=function(t){var e=this.methodChain.indexOf(t);e>-1&&(this.methodChain.splice(e,1),this.methodChain.length>0?this.rebindMethodChain():this.destory())},t.prototype.rebindMethodChain=function(){this.boundMethodChain=[];for(var t=void 0,e=0;t=this.methodChain[e];e++){var n=this.boundMethodChain[e-1]||this.originalMethodReference.bind(this.context);this.boundMethodChain.push(t(n))}},t.prototype.destory=function(){var t=u.indexOf(this);t>-1&&(u.splice(t,-1),this.context[this.methodName]=this.originalMethodReference)},t}();function p(t,e){return u.filter((function(n){return n.context===t&&n.methodName===e}))[0]}function l(t,e){var n=p(t,e);return n||(n=new h(t,e),u.push(n)),n}var d="gclid",v="dclid",f="is_seller",g="shopee_key",_="gbraid",m="wbraid",y=[d,v,"utm_source","utm_medium","utm_campaign","utm_content",_,m,"utm_term","affiliate_trackid","uls_trackid"];function b(t){var e={},n=(t=t||"").indexOf("?");if(-1!==n){var o=t.substring(n+1);(o=o.split("#")[0]).split("&").forEach((function(t){if(t){var n=t.indexOf("="),o=n>-1?t.substring(0,n):t,r=n>-1?decodeURIComponent(t.substring(n+1)):"";e[o]=r}}))}return e}function k(t){return Object.keys(t).length<=0}var w=Boolean(e.document&&e.document.createElement);function S(t,e){return Object.prototype.hasOwnProperty.call(t,e)}function T(t){var n=t||{},o={};if(function(t,e){return e.some((function(e){return!!S(t,e)}))}(n,y)){o=function(t,e){return e.reduce((function(e,n){var o;return"string"==typeof t[n]&&t[n].length>0?r(r({},e),((o={})[n]=t[n],o)):e}),{})}(n,y)||{};var a=Object.keys(o);a.includes(d)?o[g]=d:a.includes(v)?o[g]=v:a.includes(_)?o[g]=_:a.includes(m)?o[g]=m:Object.keys(o).includes(v)&&(o[g]=v)}return S(n,f)&&(o[f]="true"===n[f]),r(r({},o),function(){var t,n,o=e.document.referrer;if(!o)return{};var r=null!==(n=null===(t=o.match(/:\/\/(.[^/]+)/))||void 0===t?void 0:t[1])&&void 0!==n?n:"";if(!r)return{};var a=function(t){for(var e=0;e<s.length;e++)if(-1!==t.indexOf(s[e]))return s[e];return-1!==t.indexOf(c)?"amp":null}(r);if(a)return{stm_source:"".concat(a),stm_medium:"organic"};return{stm_source:"".concat(o),stm_medium:"referral"}}())}function E(t){var e={};return Object.prototype.hasOwnProperty.call(t,"event_source")&&(e.event_source=t.event_source),e}function x(t){if(t.hash&&t.hash.startsWith("#/")){var e=t.hash.lastIndexOf("#");return 0===e?t.hash.substring(1):t.hash.substring(1,e)}return t.pathname}var P=function(){function t(t){this.flag="UBTTracker";var n={shouldTrackHistoryChange:this.shouldTrackHistoryChange,trackReplaceState:!1};this.opts=r(r({},n),t),this.path=e.location.pathname+e.location.hash+e.location.search,this.pathname=x(e.location),this.eventId=e.trackingSessionManager.getLatestEventId(),this.pushStateOverride=this.pushStateOverride.bind(this),this.replaceStateOverride=this.replaceStateOverride.bind(this),this.handlePopState=this.handlePopState.bind(this),this.handleHashChange=this.handleHashChange.bind(this),this.handleLoad=this.handleLoad.bind(this),self.history?(h.add(history,"pushState",this.pushStateOverride),h.add(history,"replaceState",this.replaceStateOverride),window.addEventListener("popstate",this.handlePopState)):window.addEventListener("hashchange",this.handleHashChange),this.handleLoad()}return t.prototype.pushStateOverride=function(t){var e=this;return function(){for(var n=[],o=0;o<arguments.length;o++)n[o]=arguments[o];t.apply(void 0,n),e.handleHistoryChange(!0)}},t.prototype.replaceStateOverride=function(t){var e=this;return function(){for(var n=[],o=0;o<arguments.length;o++)n[o]=arguments[o];t.apply(void 0,n),e.handleHistoryChange(!1)}},t.prototype.handlePopState=function(){this.handleHistoryChange(!0)},t.prototype.handleHashChange=function(){this.handleHistoryChange(!0)},t.prototype.handleLoad=function(){var t=this,n={isOnload:!0,referrer:"".concat(e.document.referrer),eventId:this.eventId,href:"".concat(e.location.href),hostname:"".concat(e.location.hostname),pathname:this.pathname,absolutePath:"".concat(e.location.host).concat(e.location.pathname).concat(e.location.hash)};setTimeout((function(){try{t.sendPageview(n)}catch(t){console.warn("[AutoTracker]",t)}}),300)},t.prototype.sendPageview=function(t){return a(this,void 0,void 0,(function(){var n,o,a,s,c,u,h,p,l,d;return i(this,(function(i){switch(i.label){case 0:return[4,e.trackingSessionManager.getSession({flag:this.flag,reset:!1})];case 1:return n=i.sent(),o=Date.now(),a=b(t.href),s={auto_mapped_view:e.trackingSessionManager.getLatestViewPageType(),auto_refer:t.referrer,auto_pathname:t.pathname,auto_url:t.href,start_time:o},k(a)||(s.param_string=JSON.stringify(a)),!k(c=E(a))&&(s=r(r({},s),c)),function(t){if(!t)return!1;var e=new URL(t),n=new URLSearchParams(e.search);return!!y.some((function(t){return n.has(t)}))}(t.href)?(!k(u=T(a))&&(s=r(r({},s),u)),[4,e.trackingSessionManager.getSession({flag:this.flag,reset:!0})]):[3,3];case 2:n=i.sent(),i.label=3;case 3:return h=this.opts.tracker.getABTest(),p={civ_id:t.eventId,data:{auto_pv_common:s},sequence_id:n.sequenceId,session_id:n.sessionId,ab_test:h,event_timestamp:o,type:"v4",platform_implementation:"pc",auto_view_id:"browser-abs|"+t.absolutePath,operation:"auto_view"},this.opts.autoTrackMatchRoutes&&(l=this.opts.autoTrackMatchRoutes(t.pathname),d=this.opts.autoTrackMatchRoutes(function(t){try{return new URL(t).pathname}catch(e){return t}}(t.referrer)),p.auto_view_id=l?"browser|".concat(l):p.auto_view_id,p.data.auto_pv_common.auto_refer=d?"browser|".concat(d):p.data.auto_pv_common.auto_refer),this.opts.autoTrackExtra&&(p.data.auto_track_extra=this.opts.autoTrackExtra),this.opts.tracker.logEvent(p),[2]}}))}))},t.prototype.shouldTrackHistoryChange=function(t,e){return!(!t||!e)},t.prototype.handleHistoryChange=function(t){var n,o=this,r=this.path,a=this.pathname,i=e.location.pathname+e.location.hash+e.location.search,s=x(e.location);if(r!==i&&(null===(n=this.opts.shouldTrackHistoryChange)||void 0===n?void 0:n.call(this,i,r))&&(this.path=i,this.pathname=s,t||this.opts.trackReplaceState)){this.eventId=e.uuidv4(),e.scheduleWhenIdle((function(){e.trackingSessionManager.setLatestEventId(o.eventId)}));var c={isOnload:!1,referrer:a,eventId:this.eventId,href:"".concat(e.location.href),hostname:"".concat(e.location.hostname),pathname:this.pathname,absolutePath:"".concat(e.location.host).concat(e.location.pathname).concat(e.location.hash)};setTimeout((function(){try{o.sendPageview(c)}catch(t){console.warn("[AutoTracker]",t)}}),300)}},t}();var I=function(t){function n(n){var o=t.call(this,n)||this;return o.validEventTypes=["ubt","tss"],o.flag="UBTTracker",o.batchNumber=20,o.previousPageType="",o.storage=window.indexedDB?new e.IndexedDBStorage(4):e.MemoStorage.getInstance(),o.user_id=NaN,o.ab_test="",o.new_domain_enable=!1,o.keepalive_enable=!1,o.options=r({env:"live",enableAutoTrack:!0,sendImmediately:!1},n),o.isOnload=!0,o}return o(n,t),n.prototype.init=function(t){var n,o=t.version,r=t.sdkConfig;return a(this,void 0,void 0,(function(){return i(this,(function(t){switch(t.label){case 0:return this.options.sdk_version=o||"0.0.0",this.keepalive_enable=null!==(n=null==r?void 0:r.keepalive)&&void 0!==n&&n,this.new_domain_enable=!(!r||!r[this.options.locale]),[4,this.storage.init()];case 1:return t.sent(),[4,this.storage.removeExpiredEvents()];case 2:return t.sent(),e.trackingSessionManager.useStorage(this.storage),e.trackingSessionManager.setLatestEventId(e.uuidv4()),!1!==this.options.enableAutoTrack&&(this.autoTracker=new P({tracker:this,autoTrackMatchRoutes:this.options.autoTrackMatchRoutes,autoTrackExtra:this.options.autoTrackExtra})),this.initScheduler(),[2]}}))}))},n.prototype.setNewDomainEnable=function(t){this.new_domain_enable=t},n.prototype.setUserId=function(t){this.user_id=t},n.prototype.getUserId=function(){return this.user_id},n.prototype.setABTest=function(t){this.ab_test=t},n.prototype.getABTest=function(){return this.ab_test},n.prototype.logDirectly=function(t,n){var o=this;if(null==n?void 0:n.isExitPage)return t.page_type=this.previousPageType,this.sendData([t],{isTss:n.isTss,keepalive:!0});var r=(null==n?void 0:n.isTss)?"tss":"ubt",a=null;return this.storage.addEvent(t,r).then((function(){return o.storage.getEvents(o.batchNumber,r).then((function(t){return a=t,o.sendData(a.data,n).then((function(){o.storage.removeEvents((null==a?void 0:a.keys)||[])}))})).catch((function(t){return console.warn(t),a?(null==a?void 0:a.keys)&&o.storage instanceof e.IndexedDBStorage?o.storage.resetEvents(a.keys):o.storage.resetEvents([],a.data,r):Promise.resolve()}))}))},n.prototype.logBatchly=function(t){return this.storage.addEvent(t)},n.prototype.logJSBridge=function(t){},n.prototype.preProcess=function(t){return a(this,void 0,void 0,(function(){var n,o,a,s,c,u,h,p;return i(this,(function(i){switch(i.label){case 0:return n=e.trackingSessionManager.getLatestEventId(),void 0!==t.sequence_id&&void 0!==t.session_id?[3,2]:[4,e.trackingSessionManager.getSession({flag:this.flag,reset:!1})];case 1:o=i.sent(),t.sequence_id=o.sequenceId,t.session_id=o.sessionId,i.label=2;case 2:return"view"===t.operation&&(a=function(){if(!w||!e.location)return null;var t={};try{t=b("".concat(e.location.href))}catch(t){console.warn("[getParams]",t)}var n={},o=E(t);k(o)||(n=o);var a=T(t);return k(a)||(n=r(r({},n),a)),k(n)?null:r(r({},n),{auto_url:self.location.href})}(),this.isOnload=!1,a&&((s=r({},t.data)).view_common=r(r({},s.view_common),a),t.data=s),this.previousPageType=t.page_type),c=function(t){var n={event_timestamp:Date.now(),device_id:t.device_id||e.getCookie("SPC_F")||e.getDEDeviceID(),country:t.locale,platform:t.platform,platform_implementation:"pc",user_agent:"undefined"!=typeof navigator?navigator.userAgent:"",usage_id:0,token:t.token||"",operation:"",page_type:"",page_section:"",target_type:"",app_id:t.appId,signature:t.signature||"",type:"v4",domain:location.hostname,de_device_id:e.getDEDeviceID(),sdk_version:t.sdk_version||"0.0.0"},o=t.sapid;if(o){var r={sapid:o};n.extra_data=r}return n}(this.options),u=function(t,e){try{if(!window.__abtest__)return{};if("function"!=typeof window.__abtest__.getVersion||"function"!=typeof window.__abtest__.getGroupIdByPointId)return{};var n=window.__abtest__.getVersion(),o=t.operation,r=t.page_type,a=t.page_section,i=t.target_type,s=t.tracker_id,c=s?String(s):"".concat(o,".").concat(e.appId||0,".").concat(null!=r?r:"",".").concat(null!=a?a:"",".").concat(null!=i?i:"");if(!c)return{};var u=window.__abtest__.getGroupIdByPointId(c);return u.length>1e3?{}:{exp_version:n,exp_group_id:u}}catch(t){return console.error(t),{}}}(t,this.options),h=u.exp_version,p=u.exp_group_id,[2,this.addDfpSps(r(r(r({civ_id:n},c),t),{user_id:this.user_id||t.user_id,ab_test:this.ab_test||t.ab_test,exp_version:h,exp_group_id:p}))]}}))}))},n.prototype.addDfpSps=function(t){try{if("function"==typeof this.options.getDfp&&(t.sequence_id<11||t.sequence_id<=50&&t.sequence_id%5==0)){var e=this.options.getDfp();e&&"string"==typeof e&&e.length<2560&&(t.dfp_sps=e)}}catch(t){console.error("[@shopee/tracking-ubt addDfpSps error]",t)}return t},n.prototype.isTssEvent=function(t){return!("view"!==t.operation&&"auto_view"!==t.operation||!function(t){if(!t.data)return!1;var e=t.data.view_common||t.data.auto_pv_common;if(!e)return!1;var n=Object.keys(e);return!!y.some((function(t){return n.includes(t)}))}(t))},n.prototype.sendData=function(t,n){return a(this,void 0,void 0,(function(){var o,r,a;return i(this,(function(i){switch(i.label){case 0:return o=null==n?void 0:n.isTss,r=null==n?void 0:n.keepalive,0===t.length?[2]:(a=o?this.realSendData(t,e.getEndpoint(this.options.env,"v4/tss/tr",this.options.locale,{enableNewDomain:this.new_domain_enable,isTss:!0}),{securedPost:this.options.secured_post,keepalive:r}):this.realSendData(t,e.getEndpoint(this.options.env,"v4/tr",this.options.locale,{enableNewDomain:this.new_domain_enable}),{keepalive:r}),[4,Promise.all([a])]);case 1:return i.sent(),[2]}}))}))},n.prototype.realSendData=function(t,n,o){var r=this,a={"X-SPC-DF":t[0].device_id,"Content-Type":"application/json"},i=o.securedPost,s=o.keepalive;return Promise.all(e.constraintSize(t,O).map((function(t){return e.withRetry((function(){return e.request(n,{headers:a,body:JSON.stringify(t),securedPost:i,keepalive:r.keepalive_enable||s}).then((function(t){return 200!==(null==t?void 0:t.status)?Promise.reject():t}))}),1e3,"INF")})))},n.prototype.initScheduler=function(){var t=this;this.myScheduler=new e.Scheduler({onInterval:function(){return a(t,void 0,void 0,(function(){var t,n=this;return i(this,(function(o){switch(o.label){case 0:return t=this.validEventTypes.map((function(t){return a(n,void 0,void 0,(function(){var n,o;return i(this,(function(r){switch(r.label){case 0:return[4,this.storage.getEvents(this.batchNumber,t)];case 1:if(0===(n=r.sent()).data.length)return[2,Promise.resolve()];r.label=2;case 2:return r.trys.push([2,4,,5]),[4,this.sendData(n.data,{isTss:"tss"===t})];case 3:return r.sent(),[2,this.storage.removeEvents((null==n?void 0:n.keys)||[])];case 4:return o=r.sent(),console.warn(o),n?(null==n?void 0:n.keys)&&this.storage instanceof e.IndexedDBStorage?[2,this.storage.resetEvents(n.keys)]:[2,this.storage.resetEvents([],n.data,t)]:[2,Promise.resolve()];case 5:return[2]}}))}))})),[4,Promise.all(t)];case 1:return o.sent(),[2,Promise.resolve()]}}))}))},onFinish:function(){return a(t,void 0,void 0,(function(){return i(this,(function(t){return[2]}))}))},onError:function(e){return a(t,void 0,void 0,(function(){return i(this,(function(t){return console.warn(e),[2]}))}))},onUnload:function(){return a(t,void 0,void 0,(function(){return i(this,(function(t){return[2]}))}))}})},n}(e.ITracker);function O(t){var e=Math.ceil(t.length/2);return e===t.length?[t]:[t.slice(0,e),t.slice(e,t.length)]}var C=function(t){function n(o){var r=t.call(this,o)||this;return r.flag="UBTTracker",e.runningInstance.set(n,r),r}return o(n,t),n.prototype.click=function(t,e,n,o,r){void 0===r&&(r=null),this.logEvent({page_type:t,page_section:e,target_type:n,operation:"click",platform_implementation:o,data:r})},n.prototype.impression=function(t,e,n,o,r){void 0===r&&(r=null),this.logEvent({page_type:t,page_section:e,target_type:n,operation:"impression",platform_implementation:o,data:r})},n.prototype.view=function(t,e,n){void 0===n&&(n=null),this.logEvent({page_type:t,operation:"view",platform_implementation:e,data:n})},n.prototype.trackEvent=function(t,e,n,o,r,a){this.logEvent({page_type:e,page_section:n,target_type:o,operation:t,platform_implementation:r,data:a})},n.prototype.logEventV3=function(t){var e,n,o,r,a,i,s,c,u,h,p,l,d,v,f=(o=(n=e=t).timestamp,r=n.session_id,a=void 0===r?void 0:r,i=n.sequence_id,s=void 0===i?void 0:i,c=n.ab_test,u=void 0===c?void 0:c,h=n.source,p=e.info,l=p.page_type,d=p.operation,v=p.target_type,{event_timestamp:o,sequence_id:s,session_id:a,page_type:l,page_section:p.page_section,operation:d,target_type:v,ab_test:u,data:p.data,platform_implementation:h});this.logEvent(f)},n.prototype.track=function(t){var n=e.pick(t,["operation","tracker_id","position_id","target_type","target_type_ext","target_property","target_property_ext","platform_implementation","data","page_section","page_type"]);this.logEvent(n)},n.prototype.exitPageTrack=function(t){var n=e.pick(t,["operation","tracker_id","position_id","target_type","target_type_ext","target_property","target_property_ext","platform_implementation","data","page_section"]);this.logExitPageEvent(n)},n}(I);t.CoreTracker=I,t.UBTTracker=C,t.default=C,Object.defineProperty(t,"__esModule",{value:!0})}));